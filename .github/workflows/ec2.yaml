name: Deploy FastAPI and Streamlit to EC2

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DB_ENV: "cloud"
      POSTGRES_USER: "postgres.mrnvymnblankzratdavt"
      POSTGRES_HOST: "aws-1-ap-northeast-2.pooler.supabase.com"
      POSTGRES_PORT: "6543"
      POSTGRES_DB: "postgres"
      HOST: "0.0.0.0" # HOST ë³€ìˆ˜ ì¶”ê°€

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.LANGGRAPH_EC2_HOST }}
        username: ${{ secrets.LANGGRAPH_EC2_USERNAME }}
        key: ${{ secrets.LANGGRAPH_EC2_SSH_KEY }}
        script: |
          # --- ë³€ìˆ˜ ì„¤ì • ---
          BRANCH_NAME="${{ github.ref_name }}"
          HOME_DIR="/home/${{ secrets.LANGGRAPH_EC2_USERNAME }}"
          PROJECT_DIR="${HOME_DIR}/SW-project"
          REPO_URL="https://github.com/kanggihoo/streamlit-langgraph-fastapi.git"
          FASTAPI_SERVICE_NAME="fastapi-server.service"
          STREAMLIT_SERVICE_NAME="streamlit-server.service"
          FASTAPI_PORT=8001
          STREAMLIT_PORT=8501

          echo "================================================="
          echo "ğŸš€ ë“€ì–¼ ì„œë²„ ë°°í¬ ì‹œì‘: $(date)"
          echo "BRANCH: ${BRANCH_NAME}"
          echo "PROJECT_DIR: ${PROJECT_DIR}"
          echo "================================================="

          # --- Git ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜ (í•„ìš” ì‹œ) ---
          if ! command -v git &> /dev/null; then
              echo "gitì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤..."
              sudo yum update -y && sudo yum install git -y
              echo "git ì„¤ì¹˜ ì™„ë£Œ."
          else
              echo "gitì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          fi
              
          # --- Git í”„ë¡œì íŠ¸ í´ë¡  ë˜ëŠ” ì—…ë°ì´íŠ¸ ---
          if [ ! -d "$PROJECT_DIR/.git" ]; then
              echo "ğŸ“ í”„ë¡œì íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œ clone í•©ë‹ˆë‹¤..."
              rm -rf "$PROJECT_DIR" # ê¸°ì¡´ ë””ë ‰í† ë¦¬ ì •ë¦¬
              git clone "${REPO_URL}" "$PROJECT_DIR"
          else
              echo "ğŸ“ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
          fi
    
          cd "$PROJECT_DIR" || { echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì‹¤íŒ¨"; exit 1; }
          git pull origin "${BRANCH_NAME}"
          echo "ğŸ”„ Git ì €ì¥ì†Œë¥¼ ìµœì‹  ìƒíƒœë¡œ ì—…ë°ì´íŠ¸ ì™„ë£Œ."

          # --- uv ì„¤ì¹˜ ë° Python ê°€ìƒí™˜ê²½ ì„¤ì • ---
          if ! command -v uv &> /dev/null; then
              echo "uvê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤..."
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.local/bin:$PATH"
              echo "uv ì„¤ì¹˜ ë° PATH ì„¤ì • ì™„ë£Œ."
          else
              echo "uvê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          fi
          
          if [ ! -d ".venv" ]; then
              echo "ğŸ“¦ Python ê°€ìƒí™˜ê²½ì„ ìƒì„±í•©ë‹ˆë‹¤..."
              uv venv
          fi
          echo "ğŸ ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜/ë™ê¸°í™”..."
          source .venv/bin/activate
          uv sync
          echo "âœ… ê°€ìƒí™˜ê²½ ë° ì˜ì¡´ì„± ì„¤ì • ì™„ë£Œ."

          # --- ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° í¬íŠ¸ ì •ë¦¬ ---
          echo "ğŸ”„ ê¸°ì¡´ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•˜ê³  í¬íŠ¸ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤..."
          sudo systemctl stop ${FASTAPI_SERVICE_NAME} || true
          sudo systemctl stop ${STREAMLIT_SERVICE_NAME} || true
          sudo lsof -ti:${FASTAPI_PORT} | xargs -r sudo kill -9 || true
          sudo lsof -ti:${STREAMLIT_PORT} | xargs -r sudo kill -9 || true
          sleep 3
          echo "âœ… ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° í¬íŠ¸ ì •ë¦¬ ì™„ë£Œ."

          # --- í™˜ê²½ ë³€ìˆ˜ (.env) íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸ ---
          echo "ğŸ”‘ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼(.env)ì„ ìƒì„±/ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
          cat << EOF > "$PROJECT_DIR/.env"
          OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          GOOGLE_API_KEY="${{ secrets.GOOGLE_API_KEY }}"
          OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}"
          POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"

          DB_ENV="${{ env.DB_ENV }}"
          POSTGRES_USER="${{ env.POSTGRES_USER }}"
          POSTGRES_HOST="${{ env.POSTGRES_HOST }}"
          POSTGRES_PORT="${{ env.POSTGRES_PORT }}"
          POSTGRES_DB="${{ env.POSTGRES_DB }}"
          HOST="${{ env.HOST }}"
          EOF
          chmod 600 "$PROJECT_DIR/.env"
          echo "âœ… í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ."
          
          # --- FastAPI systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ---
          echo "âš™ï¸ FastAPI systemd ì„œë¹„ìŠ¤ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤..."
          cat << EOF > "${HOME_DIR}/temp-fastapi.service"
          [Unit]
          Description=FastAPI Server for SW-project
          After=network.target

          [Service]
          User=${{ secrets.LANGGRAPH_EC2_USERNAME }}
          Group=$(id -gn ${{ secrets.LANGGRAPH_EC2_USERNAME }})
          WorkingDirectory=${PROJECT_DIR}
          EnvironmentFile=${PROJECT_DIR}/.env
          ExecStart=${HOME_DIR}/.local/bin/uv run python3 src/run_server.py
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOF
          sudo mv "${HOME_DIR}/temp-fastapi.service" "/etc/systemd/system/${FASTAPI_SERVICE_NAME}"
          sudo chmod 644 "/etc/systemd/system/${FASTAPI_SERVICE_NAME}"
          echo "âœ… FastAPI ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì™„ë£Œ."

          # --- Streamlit systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ---
          echo "ğŸ¨ Streamlit systemd ì„œë¹„ìŠ¤ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤..."
          cat << EOF > "${HOME_DIR}/temp-streamlit.service"
          [Unit]
          Description=Streamlit Server for SW-project
          After=network.target

          [Service]
          User=${{ secrets.LANGGRAPH_EC2_USERNAME }}
          Group=$(id -gn ${{ secrets.LANGGRAPH_EC2_USERNAME }})
          WorkingDirectory=${PROJECT_DIR}
          EnvironmentFile=${PROJECT_DIR}/.env
          ExecStart=${PROJECT_DIR}/.venv/bin/streamlit run src/streamlit_app.py --server.port ${STREAMLIT_PORT} --server.headless true
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOF
          sudo mv "${HOME_DIR}/temp-streamlit.service" "/etc/systemd/system/${STREAMLIT_SERVICE_NAME}"
          sudo chmod 644 "/etc/systemd/system/${STREAMLIT_SERVICE_NAME}"
          echo "âœ… Streamlit ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì™„ë£Œ."

          # --- systemd ì„œë¹„ìŠ¤ ì¬ë¡œë“œ, í™œì„±í™” ë° ì¬ì‹œì‘ ---
          echo "ğŸ”„ systemd ë°ëª¬ì„ ì¬ë¡œë“œí•˜ê³  ë‘ ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™” ë° ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
          sudo systemctl daemon-reload
          sudo systemctl enable ${FASTAPI_SERVICE_NAME}
          sudo systemctl enable ${STREAMLIT_SERVICE_NAME}
          sudo systemctl restart ${FASTAPI_SERVICE_NAME}
          sudo systemctl restart ${STREAMLIT_SERVICE_NAME}
          echo "âœ… ë‘ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì¬ì‹œì‘ ëª…ë ¹ì„ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤."

          # --- ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ---
          sleep 5
          echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
          
          # FastAPI ì„œë²„ ìƒíƒœ í™•ì¸
          if sudo systemctl is-active --quiet ${FASTAPI_SERVICE_NAME}; then
              echo "ğŸ‰ (1/2) FastAPI ì„œë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
              echo "   - ì£¼ì†Œ: http://${{ secrets.LANGGRAPH_EC2_HOST }}:${FASTAPI_PORT}"
          else
              echo "âŒ (1/2) FastAPI ì„œë²„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
              echo "--- FastAPI ìµœê·¼ ë¡œê·¸ 50ì¤„ ---"
              sudo journalctl -u ${FASTAPI_SERVICE_NAME} --no-pager -n 50
              exit 1
          fi

          # Streamlit ì„œë²„ ìƒíƒœ í™•ì¸
          if sudo systemctl is-active --quiet ${STREAMLIT_SERVICE_NAME}; then
              echo "ğŸ‰ (2/2) Streamlit ì„œë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
              echo "   - ì£¼ì†Œ: http://${{ secrets.LANGGRAPH_EC2_HOST }}:${STREAMLIT_PORT}"
          else
              echo "âŒ (2/2) Streamlit ì„œë²„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
              echo "--- Streamlit ìµœê·¼ ë¡œê·¸ 50ì¤„ ---"
              sudo journalctl -u ${STREAMLIT_SERVICE_NAME} --no-pager -n 50
              exit 1
          fi

          echo "================================================="
          echo "âœ… ëª¨ë“  ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤: $(date)"
          echo "================================================="

