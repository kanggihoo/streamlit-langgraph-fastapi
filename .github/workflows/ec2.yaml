name: Deploy FastAPI and Streamlit to EC2

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.LANGGRAPH_EC2_HOST }}
        username: ${{ secrets.LANGGRAPH_EC2_USERNAME }}
        key: ${{ secrets.LANGGRAPH_EC2_SSH_KEY }}
        script: |
          # --- ë³€ìˆ˜ ì„¤ì • (Worker ë°°í¬ìš©) ---
          BRANCH_NAME="${{ github.ref_name }}"
          HOME_DIR="/home/${{ secrets.LANGGRAPH_EC2_USERNAME }}"
          PROJECT_DIR="${HOME_DIR}/SW-project"
          REPO_URL="https://github.com/kanggihoo/streamlit-langgraph-fastapi.git"
          SERVICE_NAME="taskqueue-worker.service"
          

          echo "================================================="
          echo "Worker ì„œë²„ ë°°í¬ ì‹œì‘: $(date)"
          echo "BRANCH: ${BRANCH_NAME}"
          echo "PROJECT_DIR: ${PROJECT_DIR}"
          echo "================================================="

          # --- Git ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜ (í•„ìš” ì‹œ) ---
          if ! command -v git &> /dev/null; then
              echo "gitì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤..."
              sudo yum update -y && sudo yum install git -y
              echo "git ì„¤ì¹˜ ì™„ë£Œ."
          else
              echo "gitì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          fi
              
          # --- Git í”„ë¡œì íŠ¸ í´ë¡  ë˜ëŠ” ì—…ë°ì´íŠ¸ ---
          if [ ! -d "$PROJECT_DIR/.git" ]; then
              echo "ğŸ“ í”„ë¡œì íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œ clone í•©ë‹ˆë‹¤..."
              rm -rf "$PROJECT_DIR" # ê¸°ì¡´ ë””ë ‰í† ë¦¬ ì •ë¦¬
              git clone "${REPO_URL}" "$PROJECT_DIR"
          else
              echo "ğŸ“ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
          fi
    
          cd "$PROJECT_DIR" || { echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì‹¤íŒ¨"; exit 1; }
          git pull origin "${BRANCH_NAME}"
          echo "ğŸ”„ Git ì €ì¥ì†Œë¥¼ ìµœì‹  ìƒíƒœë¡œ ì—…ë°ì´íŠ¸ ì™„ë£Œ."

          # --- uv ì„¤ì¹˜ ë° Python ê°€ìƒí™˜ê²½ ì„¤ì • ---
          if ! command -v uv &> /dev/null; then
              echo "uvê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤..."
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.local/bin:$PATH"
              echo "uv ì„¤ì¹˜ ë° PATH ì„¤ì • ì™„ë£Œ."
          else
              echo "uvê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          fi
          
          if [ ! -d ".venv" ]; then
              echo "ğŸ“¦ Python ê°€ìƒí™˜ê²½ì„ ìƒì„±í•©ë‹ˆë‹¤..."
              uv venv
          fi
          echo "ğŸ ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜/ë™ê¸°í™”..."
          source .venv/bin/activate
          uv sync
          echo "âœ… ê°€ìƒí™˜ê²½ ë° ì˜ì¡´ì„± ì„¤ì • ì™„ë£Œ."

          # --- ê¸°ì¡´ Worker ì„œë¹„ìŠ¤ ì¤‘ì§€ (ì¬ë°°í¬ ëŒ€ë¹„) ---
          echo "ğŸ”„ ê¸°ì¡´ Worker ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤ (ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°)..."
          if sudo systemctl is-active --quiet ${SERVICE_NAME}; then
              sudo systemctl stop ${SERVICE_NAME}
              echo "âœ… ê¸°ì¡´ Worker ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤."
          else
              echo "â„¹ï¸ ì‹¤í–‰ ì¤‘ì¸ Worker ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi
          
          # --- í™˜ê²½ ë³€ìˆ˜ (.env) íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸ ---
          echo "ğŸ”‘ Workerìš© í™˜ê²½ ë³€ìˆ˜ íŒŒì¼(.env)ì„ ìƒì„±/ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
          cat << EOF > "$PROJECT_DIR/.env"
          REDIS_HOST="${{ env.REDIS_HOST }}"
          REDIS_PORT="${{ env.REDIS_PORT }}"
          MONGODB_ATLAS_URI="${{ secrets.MONGODB_ATLAS_URI }}"

          EOF
          chmod 600 "$PROJECT_DIR/.env"
          echo "âœ… í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ."
          
          # --- ARQ Worker systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸ ---
          echo "âš™ï¸ ARQ Workerìš© systemd ì„œë¹„ìŠ¤ íŒŒì¼ì„ ìƒì„±/ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
          cat << EOF > "${HOME_DIR}/temp-${SERVICE_NAME}"
          [Unit]
          Description=ARQ Task Queue Worker for SW-project
          After=network.target

          [Service]
          User=${{ secrets.LANGGRAPH_EC2_USERNAME }}
          Group=$(id -gn ${{ secrets.LANGGRAPH_EC2_USERNAME }})
          WorkingDirectory=${PROJECT_DIR}
          EnvironmentFile=${PROJECT_DIR}/.env
          ExecStart=${PROJECT_DIR}/.venv/bin/arq src.taskqueue.worker.WorkerSettings
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOF
          sudo mv "${HOME_DIR}/temp-${SERVICE_NAME}" "/etc/systemd/system/${SERVICE_NAME}"
          sudo chmod 644 "/etc/systemd/system/${SERVICE_NAME}"
          echo "âœ… ARQ Worker ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸ ì™„ë£Œ."


          # --- systemd ì„œë¹„ìŠ¤ ì¬ë¡œë“œ, í™œì„±í™” ë° ì¬ì‹œì‘ ---
          echo "ğŸ”„ systemd ë°ëª¬ì„ ì¬ë¡œë“œí•˜ê³  Worker ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™” ë° ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
          sudo systemctl daemon-reload
          sudo systemctl enable ${SERVICE_NAME}
          sudo systemctl restart ${SERVICE_NAME}
          echo "âœ… Worker ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ëª…ë ¹ì„ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤."

          # --- Worker ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ---
          sleep 5
          echo "ğŸ” Worker ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
          
          if sudo systemctl is-active --quiet ${SERVICE_NAME}; then
              echo "ğŸ‰ Worker ì„œë¹„ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
              echo "âŒ Worker ì„œë¹„ìŠ¤ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
              echo "--- Worker ì„œë¹„ìŠ¤ ìµœê·¼ ë¡œê·¸ 50ì¤„ ---"
              sudo journalctl -u ${SERVICE_NAME} --no-pager -n 50
              exit 1
          fi

          echo "================================================="
          echo "âœ… Worker ì„œë²„ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤: $(date)"
          echo "================================================="

